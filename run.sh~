#!/bin/bash
# This script downloads gridded data from Smartmet Server (test) for nowcasting purposes

# Generate current timestamps for the Smartmet Server retrievals. Here, 3hours can be taken in as an argument (defined maybe by the radar nowcasting predictability parameter?). The retrieval time stamps are rounded to previous hour.
timestamp_now=`eval date -u -d "now" +"%Y%m%d%H"`00
timestamp_3hours=`date -u -d "now + 3 hour" +"%Y%m%d%H"`00
timestamp_m4hours=$(eval 'date -u -d "now - 4 hour" +"%Y%m%d%H"'00)
echo $timestamp_now
echo $timestamp_3hours
echo $timestamp_m4hours

#for parameters in Pressure, GeopHeight, Temperature, DewPoint, Humidity, Visibility, PressureAtStationLevel, WindSpeedMS, WindDirection, WindVectorMS, HourlyMaximumGust, WindUMS, WindVMS, SurfaceWaterPhase
for parameter in Pressure Temperature
do



# Working retrieval to ECMWF-data generated by Marko
#wget -O out2.nc --no-proxy 'smartmet.fmi.fi/download?param=Temperature&producer=ecmwf_eurooppa_pinta&format=netcdf&bbox=19.1,59.7,31.7,70.1&timesteps=24&projection=epsg:4326'


# Retrieving LAPS data over Scandinavian domain
query="wget -O latest_LAPS_"$parameter".nc --no-proxy 'http://smartmet.fmi.fi/download?param="$parameter"&producer=laps_skandinavia&format=netcdf&origintime="$timestamp_now"&bbox=4.00118791,50.00007491,42.99146951,72.99231333&projection=epsg:4326'"
echo $query
# eval $query

# Retrieving 3h pal forecast over Scandinavian domain
query="wget -O latest_pal_"$parameter".nc --no-proxy 'http://smartmet.fmi.fi/download?param="$parameter"&producer=pal_skandinavia&format=netcdf&starttime="$timestamp_3hours"&bbox=4.00118791,50.00007491,42.99146951,72.99231333&projection=epsg:4326'"
echo $query
eval $query

#wget -O latest_pal.nc --no-proxy 'smartmet.fmi.fi/download?param=Temperature&producer=pal_skandinavia&format=netcdf&bbox=4.00118791,50.00007491,42.99146951,72.99231333&timesteps=3&projection=epsg:4326'




# While retrieving data from Smartmet Server, projection 3067 does not work at the moment. Also, datas are coming with full resolution which might not be the most appropriate thing to do. If there's an option to use a common resolution for all data sources that could be used. Otherwise, interpolation will need to be done after the retrieval.

done

exit
